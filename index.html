<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Interactive Street Walkthrough</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }

    /* Loading screen */
    #loading {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #111;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
      font-size: 1.5em;
      z-index: 10;
    }
  </style>
</head>
<body>
<div id="loading">Loading street...</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
import { PointerLockControls } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/PointerLockControls.js';

let scene, camera, renderer, controls;

// Scene + Camera
scene = new THREE.Scene();
camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 1.6, 5); // human height

// Renderer
renderer = new THREE.WebGLRenderer({antialias: true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Light
const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
light.position.set(0, 20, 0);
scene.add(light);

// Load multiple street segments
const loader = new GLTFLoader();
const parts = [
  "street_part1.glb","street_part2.glb","street_part3.glb",
  "street_part4.glb","street_part5.glb","street_part6.glb",
  "street_part7.glb","street_part8.glb","street_part9.glb"
];

let loadedCount = 0;
const loadingDiv = document.getElementById('loading');

parts.forEach(file => {
  loader.load(file, (gltf) => {
    scene.add(gltf.scene);
    loadedCount++;
    loadingDiv.textContent = `Loading street... (${loadedCount}/${parts.length})`;

    if (loadedCount === parts.length) {
      loadingDiv.style.display = 'none';
    }
  }, undefined, (error) => {
    console.error("Error loading " + file, error);
    loadedCount++;
    loadingDiv.textContent = `Loading street... (${loadedCount}/${parts.length})`;
    if (loadedCount === parts.length) {
      loadingDiv.style.display = 'none';
    }
  });
});

// Controls (WASD + mouse)
controls = new PointerLockControls(camera, document.body);
document.body.addEventListener('click', () => controls.lock());

// Movement
const velocity = new THREE.Vector3();
const direction = new THREE.Vector3();
const keys = {};

document.addEventListener('keydown', e => keys[e.code] = true);
document.addEventListener('keyup', e => keys[e.code] = false);

function animate() {
  requestAnimationFrame(animate);

  if (controls.isLocked) {
    const speed = 0.05;
    direction.z = Number(keys['KeyW']) - Number(keys['KeyS']);
    direction.x = Number(keys['KeyD']) - Number(keys['KeyA']);
    direction.normalize();

    velocity.x = direction.x * speed;
    velocity.z = direction.z * speed;

    controls.moveRight(velocity.x);
    controls.moveForward(velocity.z);
  }

  renderer.render(scene, camera);
}
animate();

// Handle window resize
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
